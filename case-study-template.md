# Case-study оптимизация домашней страницы.

## Актуальная проблема

На проекте появилась проблема с тем, что главная страница долго грузится

## Формирование метрики

В качестве основного инструмента мониторинга выступал new relic. С его помощью собиралась информация о методе `StoriesController#index`, который отвечает за отрисовку главной страницы

## Feedback-Loop

Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений в среднем за 10 секунд

Вот как я построил `feedback_loop`:

1. При помощи `siege` главная страница подвергалась нагрузке, чтобы система мониторинга могла сформировать начальные метрики
2. Проводился benchmark при помощи `ab`
3. Проводились оптимизации и цикл повторялся

## Вникаем в детали системы, чтобы найти 20% точек роста

Для того, чтобы найти "точки роста" для оптимизации я воспользовался результатами мониторинга new relic и гемом `rack-miniprofiler`

Вот какие проблемы удалось найти и решить:

### Находка №1

New relic

![New relic before](/images/chart-before.png)

![New relic after](/images/table-before.png)

AB

![AB before](/images/ab-before.png)

Изначально средний ответ составлял 764ms, видно что partial `articles/_single_story.html.erb` занимает 12% процентов времени на весь ответ

New relic

![New relic after](/images/chart-after.png)

![New relic after](/images/table-after.png)

AB

![AB after](/images/ab-after.png)

## Результаты

Закешировав вызовы этого partial удалось в 3 раза ускорить страницу. В среднем страница отрисовывается за 202ms, а partial `articles/_single_story.html.erb` исчез из топа.
